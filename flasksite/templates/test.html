{% extends "layout.html" %}

{% block content %}
		<strong><link rel="stylesheet" href="static/js/nvd3/nv.d3.css"></strong>
		<script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script type="text/javascript" src="static/js/nvd3/nv.d3.js" charset="utf-8"></script>

		<meta charset="utf-8">
	

	
	

	<style>
.tick line {display: none;}
#chart svg {
  height: 400px;

}

#chart2 svg {
  height: 400px;
}

#chart3 svg {
  height: 400px;
}

#chart4 svg {
  height: 400px;
}

</style>

<p>{{overall|safe}}</p>

<div id="chart">
  <svg></svg>
</div>

<div id="chart2">
  <svg></svg>
</div>

<div id="chart3">
  <svg></svg>
</div>

<div id="chart4">
  <svg></svg>
</div>

<script type="text/javascript"> 

 
/*
var x = {{d|safe}};

//need to transform source data to match nvd3 format object array - key:source value:[[date,visits],...]
//get unique sources, then reiterate over to group by sources.
var sources = [];
for (i=0;i<x.length;i++) {
	if (x[i]['source'] )
	sources.push(x[i]['source']);}




*/

</script>
<script>
// Slightly modified code from multiBar example at
// http://nvd3.org/livecode/#codemirrorNav
// to demonstrate defaulting to stacked bar

var a = {{signups|safe}};
var b = {{newmembers|safe}};
var c = {{sources|safe}};
var ddd = {{traffic|safe}};


//make this more general so can use on other 2 data formats

var dataFormat = function(data,metric) {

  
  var m = {key:'Mobile', values:[]};
  var w = {key:'Web', values:[]};
  
  for (var i = 0; i<data.length; i++) {
    
    if (data[i].mobile) {
    
      var element = {x:data[i].date,y:data[i].mobile};
      m.values.push(element);
    }

    if (data[i].web) {

      var element = {x:data[i].date,y:data[i].web};
      w.values.push(element);
    }
  }
  if (m.values.length<1) {
    metric.push(w);

  }
  else {
  metric.push(m);
  metric.push(w);
  
  }
  return metric;

}
var sign_ups=[];

dataFormat(a,sign_ups);

var new_members=[];

dataFormat(b,new_members);


nv.addGraph(function() {
    var chart = nv.models.multiBarChart();

    chart.xAxis
        .tickFormat(function(d) { 
          return d3.time.format('%x')(new Date(d)) 
    });

    chart.yAxis
        .tickFormat(d3.format(',1f'));
    
    chart.multibar.stacked(true); // default to stacked
    chart.showControls(true); // don't show controls

    d3.select('#chart svg')
        .datum(sign_ups)
      .transition().duration(300).call(chart);

    nv.utils.windowResize(chart.update);

    return chart;
});


nv.addGraph(function() {
    var chart2 = nv.models.multiBarChart();

    chart2.xAxis
        .tickFormat(function(d) { 
          return d3.time.format('%Y-%m-%d')(new Date(d)) 
    });

    chart2.yAxis
        .tickFormat(d3.format(',1f'));
    
    chart2.multibar.stacked(true); // default to stacked
    chart2.showControls(true); // don't show controls

    d3.select('#chart2 svg')
        .datum(new_members)
      .transition().duration(300).call(chart2);

    nv.utils.windowResize(chart2.update);

    return chart2;
});

var sources = [];
var dates = [];
var formatted_sources = [];

for (var i=0; i<c.length; i++) {
  
  var s = c[i].source;
  var is_in = sources.indexOf(s);
  if (is_in===-1) {
    sources.push(s);
  }
  
}

for (var i=0; i<c.length; i++) {
  
  var d = c[i].date;
  var is_in = dates.indexOf(d);
  if (is_in===-1) {
    dates.push(d);
  }
  
}

for (var i=0; i<sources.length; i++) {
  element = {key:sources[i],values:[]}
  
  for (var x=0; x<c.length; x++) {
    var s = c[x].source;
    if (s===sources[i]) {
      var z = [];
      var date = c[x].date;
      var visits = +c[x].unq_visits;
      z.push(date,visits);
      element.values.push(z);
    }
  }
  
  formatted_sources.push(element);

}

formatted_sources.sort(function(a,b){ return b.values.length-a.values.length});
var f_source = formatted_sources.slice(0,11);

for (var i=0; i<f_source.length; i++) {
  var v = f_source[i].values;
  var current_dates = [];
  for (var x=0; x<v.length; x++) {
    var d = v[x][0];
    current_dates.push(d);
    //var is_in = dates.indexOf(d);
    //if (is_in===-1) {
    //var new_date = 
    //v.push(new_date);
  }
  
  for (var z=0; z<dates.length; z++) {
    var d2 = dates[z];
    var is_in = current_dates.indexOf(d2);
    if (is_in===-1) {
      blank_array = [d2,0];
      v.push(blank_array);}
  }

  v.sort(function(a,b){return new Date(a[0])-new Date(b[0])})

}



  nv.addGraph(function() {
    var chart3 = nv.models.stackedAreaChart()
                  .margin({right: 100})
                  //need to tell nvd3 that it's a date
                  .x(function(d) { return new Date(d[0]); })   //We can modify the data accessor functions...
                  .y(function(d) { return d[1]; })   //...in case your data is formatted differently.
                  .useInteractiveGuideline(true)    //Tooltips which show all data points. Very nice!
                   //Let's move the y-axis to the right side.
                  .transitionDuration(300)
                  .showControls(false)       //Allow user to choose 'Stacked', 'Stream', 'Expanded' mode.
                  .clipEdge(false);

    //Format x-axis labels with custom function.
    //override tick functions by giving array of tick values - need to make this dynamic
    /*
    chart3.xAxis.tickValues([new Date(data3[0].values[0][0]), new Date(data3[0].values[1][0]), new Date(data3[0].values[2][0]),new Date(data3[0].values[3][0])]);
    */
    chart3.xAxis.showMaxMin(false)
        .tickFormat(function(d) { 
          return d3.time.format("%x")(new Date(d)) 
    });

    chart3.yAxis
        .tickFormat(d3.format(',1f'));

    d3.select('#chart3 svg')
      .datum(f_source)
      .call(chart3);

    nv.utils.windowResize(chart3.update);

    return chart3;
  });
var traffic_f = [];
var t = {key:'Traffic', bar: true, color:'gray', values:[]};
var c = {key:'Conversion Rate', values:[]};

for (var i=0; i<ddd.length;i++) {
    var a = [ddd[i].date, ddd[i].conversion_rate];
    var b = [ddd[i].date, ddd[i].unq_visits];
    t.values.push(b);
    c.values.push(a);

  }
traffic_f.push(t);
traffic_f.push(c);

console.log(traffic_f);


nv.addGraph(function() {
      var chart4 = nv.models.linePlusBarChart()
            .margin({top: 30, right: 60, bottom: 50, left: 70})
            //We can set x data accessor to use index. Reason? So the bars all appear evenly spaced.
            .x(function(d,i) { return i; })
            .y(function(d,i) {return d[1] })
            ;
            //need to only display non-zero elements
      chart4.xAxis.showMaxMin(false).tickFormat(function(d) {return d3.time.format('%x')(new Date(d));})
        
     

      chart4.y1Axis
          .tickFormat(d3.format(',f'));

      chart4.y2Axis
          .tickFormat(function(d) { return d3.format('.f')(d) });

      chart4.bars.forceY([0]);

      d3.select('#chart4 svg')
        .datum(traffic_f)
        .transition()
        .duration(100)
        .call(chart4);

      nv.utils.windowResize(chart4.update);

      return chart4;
  });









</script>
{% endblock %}